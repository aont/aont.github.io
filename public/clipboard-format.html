<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Clipboard Processor</title>
  
  <link rel="stylesheet" href="style.css" />
  <script defer src="theme-selector.js"></script>
</head>
<body class="theme-root page-body">
  <main class="page-main">
<div class="container">
    <div class="card">
      <h1>Clipboard Processor</h1>
      <p class="desc">
        Reads text from your clipboard, converts line breaks into <code>&lt;div&gt;</code>-based HTML, and writes both
        <code>text/plain</code> and <code>text/html</code> back to the clipboard.<br>
        Note: On mobile, clipboard permissions and HTML writes may be restricted depending on the browser.
      </p>
    </div>

    <!-- Preset selection UI (Themeはここから外した) -->
    <div class="card controls">
      <div class="control">
        <div style="min-width: 120px;">
          <label for="preset">HTML preset</label>
          <div class="pill" id="presetBadge" style="display:inline-block;margin-top:6px;">default</div>
        </div>
        <div style="flex:1; min-width: 220px;">
          <select id="preset" aria-label="HTML preset">
            <!-- <option value="default" selected>Default</option> -->
            <option value="sansDiv" selected>DIV + sans-serif</option>
            <option value="olk">OLK Style</option>
          </select>
        </div>
      </div>
      <p class="hint">
        The selected preset changes how <code>toHtml()</code> converts line breaks. This is applied when you press the process button.
      </p>
    </div>

    <button id="process" type="button">Format and overwrite clipboard</button>

    <div class="card status">
      <div class="row" style="width:100%">
        <div id="status" class="pill">Idle</div>
        <div class="row">
          <span class="pill" id="len">Chars: -</span>
          <span class="pill" id="ua">Mobile</span>
        </div>
      </div>
      <button id="clear" type="button" class="secondary">Clear log</button>
    </div>

    <div class="card">
      <div id="log" class="log" aria-live="polite"></div>
    </div>
  </div>

<script>
  const $process = document.getElementById('process');
  const $clear = document.getElementById('clear');
  const $log = document.getElementById('log');
  const $status = document.getElementById('status');
  const $len = document.getElementById('len');
  const $ua = document.getElementById('ua');

  const $preset = document.getElementById('preset');
  const $presetBadge = document.getElementById('presetBadge');


  function nowStamp(){
    const d = new Date();
    const pad = (n)=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function appendLog(msg){
    const line = document.createElement('div');
    line.textContent = `[${nowStamp()}] ${msg}`;
    $log.appendChild(line);
    $log.scrollTop = $log.scrollHeight;
  }

  function setStatus(text, cls){
    $status.className = 'pill' + (cls ? ` ${cls}` : '');
    $status.textContent = text;
  }

  function isMobile(){
    return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  }
  $ua.textContent = isMobile() ? 'Mobile' : 'Desktop';

  function escapeHtml(str) {
    return str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  const PRESETS = {
    sansDiv: {
      name: "DIV + sans-serif",
      convertLine: (lineEscaped) => {
        let c = lineEscaped;
        if (c === "") c = "<br>";
        return "<div style=\"font-family: sans-serif\">" + c + "</div>";
      },
      joiner: ""
    },
    olk: {
      name: "olk",
      convertLine: (lineEscaped) => {
        const c = (lineEscaped === "") ? "&nbsp;" : lineEscaped;
        return "<div dir=\"ltr\" data-olk-copy-source=\"MessageBody\" style=\"border: 0px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-variant-numeric: inherit; font-variant-east-asian: inherit; font-variant-alternates: inherit; font-variant-position: inherit; font-variant-emoji: inherit; font-weight: 400; font-stretch: inherit; font-size: 12pt; line-height: inherit; font-family: &quot;Yu Gothic&quot;, 游ゴシック, YuGothic, sans-serif, serif, EmojiFont; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; font-language-override: inherit; margin: 0px; padding: 0px; vertical-align: baseline; color: black; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;\">" + c +"</div>";
      },
      joiner: ""
    }
  };
  PRESETS["default"] = PRESETS["sansDiv"];

  function toHtml(text, presetKey){
    const key = PRESETS[presetKey] ? presetKey : "default";
    const preset = PRESETS[key];

    const lines = text.split(/\r?\n/);
    const linesEscaped = lines.map(escapeHtml);

    if (preset.convertAll){
      return preset.convertAll(linesEscaped);
    }
    return linesEscaped.reduce((a, c) => a + preset.convertLine(c), "");
  }

  function updatePresetBadge(){
    const key = PRESETS[$preset.value] ? $preset.value : "default";
    $presetBadge.textContent = key;
  }


  $preset.addEventListener('change', () => {
    updatePresetBadge();
    appendLog(`Preset changed: ${$preset.value} (${PRESETS[$preset.value]?.name || "unknown"})`);
  });


  updatePresetBadge();

  function htmlToText(html){
    const wrapper = document.createElement('div');
    wrapper.innerHTML = html;
    return wrapper.innerText || "";
  }

  async function processClipboard(){
    $process.disabled = true;
    setStatus('Processing…', 'warn');

    try{
      if (!navigator.clipboard){
        throw new Error('Clipboard API is not available. Make sure you are running over HTTPS and that your browser supports it.');
      }

      let text = "";

      if (navigator.clipboard.read){
        try{
          const items = await navigator.clipboard.read();
          let htmlPayload = "";
          for (const item of items){
            if (item.types && item.types.includes("text/html")){
              const htmlBlob = await item.getType("text/html");
              htmlPayload = await htmlBlob.text();
              break;
            }
          }
          if (htmlPayload){
            text = htmlToText(htmlPayload);
            appendLog('HTML detected in clipboard; converted to text');
          }
        }catch(readError){
          appendLog(`Clipboard HTML read failed: ${readError && readError.message ? readError.message : String(readError)}`);
        }
      }

      if (!text){
        text = await navigator.clipboard.readText();
      }

      if(!text){
        setStatus('Clipboard is empty', 'warn');
        appendLog('No text found in the clipboard');
        $len.textContent = 'Chars: 0';
        return;
      }

      $len.textContent = `Chars: ${text.length}`;
      appendLog(`Input detected (${text.length} characters)`);

      const presetKey = $preset.value;
      const htmlText = toHtml(text, presetKey);
      appendLog(`HTML generated with preset: ${presetKey}`);

      await navigator.clipboard.write([new ClipboardItem({
        "text/plain": new Blob([text], {type:"text/plain"}),
        "text/html" : new Blob([htmlText], {type:"text/html"})
      })]);

      setStatus('Done', 'ok');
      appendLog('Clipboard write completed (text/plain + text/html)');

    }catch(e){
      setStatus('Failed', 'err');
      appendLog(`Error: ${e && e.message ? e.message : String(e)}`);
      appendLog('Hint: Some browsers (notably iOS Safari) may restrict writing HTML to the clipboard. Try Android Chrome or a desktop browser if needed.');
    }finally{
      $process.disabled = false;
    }
  }

  $process.addEventListener('click', processClipboard);
  $clear.addEventListener('click', () => {
    $log.textContent = '';
    setStatus('Idle');
    $len.textContent = 'Chars: -';
  });

  appendLog('Ready. Tap the button to process the clipboard.');
</script>
  </main>
</body>
</html>
