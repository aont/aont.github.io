<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Markdown Reference Converter</title>
  <style>
    :root{
      /* Dark (default) */
      --bg:#0b0f14;
      --panel:#111826;
      --panel2:#0f1623;
      --text:#e6edf3;
      --muted:#9fb0c0;
      --border:#223047;
      --success:#1f9d55;
      --warning:#d4a017;
      --danger:#d64545;
      --btn:#1b2a44;
      --btnHover:#24385b;
      --primary1:#1c3357;
      --primary2:#142847;
      --primaryHover1:#23406c;
      --primaryHover2:#162c4e;
      --focus:#4ea1ff;
      --field:#0b1220;
      --shadow:rgba(0,0,0,.25);
      --headerBg:rgba(17,24,38,.65);
    }

    /* Light theme overrides */
    :root[data-theme="light"]{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --panel2:#fbfcff;
      --text:#0b1220;
      --muted:#465569;
      --border:#d7deea;
      --btn:#eef2f8;
      --btnHover:#e4ebf6;
      --primary1:#dbeafe;
      --primary2:#bfdbfe;
      --primaryHover1:#cfe3ff;
      --primaryHover2:#b4d3ff;
      --focus:#2563eb;
      --field:#ffffff;
      --shadow:rgba(17,24,39,.12);
      --headerBg:rgba(255,255,255,.8);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:linear-gradient(180deg,var(--bg), color-mix(in srgb, var(--bg) 92%, #000 8%));
      color:var(--text);
    }
    header{
      padding:20px 16px;
      border-bottom:1px solid var(--border);
      background:var(--headerBg);
      backdrop-filter: blur(8px);
      position:sticky; top:0; z-index:2;
    }
    header h1{
      margin:0;
      font-size:18px;
      font-weight:700;
      letter-spacing:.2px;
    }
    header p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
    }
    main{
      max-width:1100px;
      margin:0 auto;
      padding:16px;
    }
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:14px;
    }
    @media(min-width:980px){
      .grid{
        grid-template-columns:1fr 1fr;
        gap:16px;
      }
      .full{grid-column:1 / -1;}
    }
    .card{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      box-shadow:0 12px 30px var(--shadow);
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .row.between{justify-content:space-between;}
    label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin:0 0 6px;
    }
    textarea{
      width:100%;
      min-height:320px;
      resize:vertical;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--field);
      color:var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:13px;
      line-height:1.45;
      outline:none;
    }
    textarea:focus, input[type="text"]:focus, select:focus{
      border-color:color-mix(in srgb, var(--focus) 70%, transparent);
      box-shadow:0 0 0 3px color-mix(in srgb, var(--focus) 18%, transparent);
    }
    textarea[readonly]{opacity:.98;}
    input[type="text"], select{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--field);
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    input[type="text"]{ width:min(420px, 100%); }
    select{ cursor:pointer; }
    button{
      appearance:none;
      border:1px solid var(--border);
      background:linear-gradient(180deg,var(--btn), color-mix(in srgb, var(--btn) 88%, #000 12%));
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
    }
    button:hover{ background:linear-gradient(180deg,var(--btnHover), color-mix(in srgb, var(--btnHover) 88%, #000 12%)); }
    button.primary{
      border-color:color-mix(in srgb, var(--focus) 55%, var(--border));
      background:linear-gradient(180deg,var(--primary1),var(--primary2));
    }
    button.primary:hover{
      background:linear-gradient(180deg,var(--primaryHover1),var(--primaryHover2));
    }
    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--field);
      color:var(--text);
      font-size:13px;
      display:none;
      white-space:pre-wrap;
    }
    .status.success{ display:block; border-color:color-mix(in srgb, var(--success) 50%, var(--border)); box-shadow:0 0 0 3px color-mix(in srgb, var(--success) 14%, transparent); }
    .status.warning{ display:block; border-color:color-mix(in srgb, var(--warning) 55%, var(--border)); box-shadow:0 0 0 3px color-mix(in srgb, var(--warning) 14%, transparent); }
    .status.danger{ display:block; border-color:color-mix(in srgb, var(--danger) 55%, var(--border)); box-shadow:0 0 0 3px color-mix(in srgb, var(--danger) 14%, transparent); }
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:var(--field);
      border:1px solid var(--border);
      padding:2px 6px;
      border-radius:8px;
      color:var(--text);
      font-size:12px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
    }
  </style>
</head>
<body>
<header>
  <div class="row between">
    <div>
      <h1>Markdown Reference Converter</h1>
      <p>Converts reference-style links into inline links and appends a readable references section.</p>
    </div>

    <div class="chip" aria-label="Theme selector">
      <label for="themeSelect" style="margin:0; font-size:12px;">Theme</label>
      <select id="themeSelect">
        <option value="auto">Auto</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <div class="row between">
        <div style="flex:1 1 auto; min-width:260px;">
          <label for="inputMarkdown">Input Markdown</label>
        </div>
        <div class="row">
          <button id="pasteBtn" type="button">Paste</button>
          <button id="convertBtn" class="primary" type="button">Convert</button>
        </div>
      </div>

      <textarea id="inputMarkdown" placeholder="Paste or type Markdown here..."></textarea>

      <div class="hint">
        Customize the heading text used for the appended references section.
      </div>

      <div class="row" style="margin-top:10px;">
        <label for="headingInput" style="margin:0;">References heading text</label>
        <input id="headingInput" type="text" value="References" />
      </div>

      <div id="status" class="status" aria-live="polite"></div>
    </section>

    <section class="card">
      <div class="row between">
        <div style="flex:1 1 auto; min-width:260px;">
          <label for="outputMarkdown">Output Markdown</label>
        </div>
        <div class="row">
          <button id="copyBtn" type="button">Copy</button>
        </div>
      </div>

      <textarea id="outputMarkdown" readonly placeholder="Converted Markdown will appear here..."></textarea>

      <div class="hint">
        If Clipboard API is unavailable, the output will be selected for manual copy.
      </div>
    </section>

    <section class="card full">
      <label>Notes</label>
      <div class="hint" style="margin-top:0;">
        <ul style="margin:6px 0 0; padding-left:18px;">
          <li>No support for multi-line reference definitions.</li>
          <li>Inline links are not transformed.</li>
          <li>Reference-style images (<span class="kbd">![alt][id]</span>) are intentionally not converted.</li>
          <li>Existing heading detection is case-sensitive for heading text.</li>
        </ul>
      </div>
    </section>
  </div>
</main>

<script>
(() => {
  const $ = (sel) => document.querySelector(sel);

  const inputMarkdown = $("#inputMarkdown");
  const outputMarkdown = $("#outputMarkdown");
  const pasteBtn = $("#pasteBtn");
  const convertBtn = $("#convertBtn");
  const copyBtn = $("#copyBtn");
  const statusEl = $("#status");
  const headingInput = $("#headingInput");
  const themeSelect = $("#themeSelect");

  const THEME_KEY = "mdRefConv.theme"; // 'auto' | 'light' | 'dark'

  function setStatus(kind, msg){
    statusEl.style.display = "block";
    statusEl.className = "status " + kind;
    statusEl.textContent = msg;
  }

  function escapeRegex(s){
    return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  function normalizeId(id){
    // Trim, collapse internal whitespace, lowercase
    return id.trim().replace(/\s+/g, " ").toLowerCase();
  }

  function escapeTooltip(s){
    // Escape backslashes and double quotes
    return s.replace(/\\/g, "\\\\").replace(/"/g, '\\"');
  }

  function parseReferenceDefinitionLine(line){
    // [id]: url
    // [id]: <url>
    // optional title: "title" | 'title' | (title)
    const re = /^\s*\[([^\]]+)\]\s*:\s*(?:<([^>\s]+)>|([^\s]+))\s*(?:(?:"([^"]*)")|(?:'([^']*)')|(?:\(([^)]*)\)))?\s*$/;
    const m = line.match(re);
    if(!m) return null;

    const idRaw = m[1];
    const url = (m[2] || m[3] || "").trim();
    const title = (m[4] ?? m[5] ?? m[6] ?? "").trim();

    if(!idRaw || !url) return null;
    return { idRaw, url, title: title || null };
  }

  function hasExistingHeading(body, headingText){
    // ATX heading #..######, up to 3 spaces indentation, exact heading text, case-sensitive
    const escaped = escapeRegex(headingText);
    const re = new RegExp("^(?: {0,3})#{1,6}[\\t ]+" + escaped + "[\\t ]*$", "m");
    return re.test(body);
  }

  function convert(markdown, headingText){
    const lines = markdown.split(/\r?\n/);

    // Parse definitions; non-parsing lines stay in body
    const defs = new Map(); // normalizedId -> { url, title, idRaw }
    const bodyLines = [];
    for(const line of lines){
      const parsed = parseReferenceDefinitionLine(line);
      if(parsed){
        const nid = normalizeId(parsed.idRaw);
        if(!defs.has(nid)){
          defs.set(nid, { url: parsed.url, title: parsed.title, idRaw: parsed.idRaw });
        }
      }else{
        bodyLines.push(line);
      }
    }
    let body = bodyLines.join("\n");

    // Convert reference-style links in body, excluding images and unresolved IDs
    const usedOrder = [];
    const usedSet = new Set();

    // Matches [label][id] and [label][]
    const linkRe = /(!)?\[([^\]\n]+)\]\[([^\]\n]*)\]/g;
    body = body.replace(linkRe, (full, bang, label, idPart) => {
      if(bang) return full; // exclude images

      const idResolved = (idPart && idPart.length > 0) ? idPart : label; // collapsed uses label
      const nid = normalizeId(idResolved);

      const def = defs.get(nid);
      if(!def) return full; // unresolved: unchanged

      if(!usedSet.has(nid)){
        usedSet.add(nid);
        usedOrder.push(nid);
      }

      const url = def.url;
      const title = def.title;

      const tooltipRaw = title
        ? `${label}: ${title} ${url}`
        : `${label} ${url}`;
      const tooltip = escapeTooltip(tooltipRaw);

      // Use resolved id (trimmed + whitespace-collapsed) for display
      const idDisplay = idResolved.trim().replace(/\s+/g, " ");
      return `[${idDisplay}](${url} "${tooltip}")`;
    });

    // Append references section (if used and heading doesn't already exist)
    if(usedOrder.length > 0 && !hasExistingHeading(body, headingText)){
      const refLines = [];
      refLines.push(`## ${headingText}`);
      for(const nid of usedOrder){
        const def = defs.get(nid);
        const titleOrUrl = def.title ? def.title : def.url;
        const idDisplay = (def.idRaw || "").trim().replace(/\s+/g, " ") || nid;
        refLines.push(`- (${idDisplay}) ${titleOrUrl} [${def.url}](${def.url})`);
      }

      const needsNewline = body.length > 0 && !body.endsWith("\n");
      body = body + (needsNewline ? "\n" : "") + "\n" + refLines.join("\n");
    }

    return body;
  }

  // Theme handling: auto uses system preference; light/dark forces.
  function applyTheme(mode){
    // mode: 'auto' | 'light' | 'dark'
    if(mode === "light"){
      document.documentElement.setAttribute("data-theme", "light");
    }else if(mode === "dark"){
      document.documentElement.removeAttribute("data-theme"); // default is dark
    }else{
      // auto
      const prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
      if(prefersLight){
        document.documentElement.setAttribute("data-theme", "light");
      }else{
        document.documentElement.removeAttribute("data-theme");
      }
    }
  }

  function loadTheme(){
    const saved = localStorage.getItem(THEME_KEY) || "auto";
    themeSelect.value = saved;
    applyTheme(saved);
  }

  function saveTheme(mode){
    localStorage.setItem(THEME_KEY, mode);
  }

  // React to system changes when in auto mode
  const mql = window.matchMedia ? window.matchMedia("(prefers-color-scheme: light)") : null;
  if(mql && mql.addEventListener){
    mql.addEventListener("change", () => {
      if((localStorage.getItem(THEME_KEY) || "auto") === "auto"){
        applyTheme("auto");
      }
    });
  }else if(mql && mql.addListener){
    // Safari fallback
    mql.addListener(() => {
      if((localStorage.getItem(THEME_KEY) || "auto") === "auto"){
        applyTheme("auto");
      }
    });
  }

  themeSelect.addEventListener("change", () => {
    const mode = themeSelect.value;
    saveTheme(mode);
    applyTheme(mode);
    setStatus("success", `Theme set to: ${mode}`);
  });

  async function pasteFromClipboard(){
    try{
      if(!navigator.clipboard || !navigator.clipboard.readText){
        setStatus("danger", "Clipboard API is unavailable (navigator.clipboard.readText not supported).");
        return;
      }
      const text = await navigator.clipboard.readText();
      inputMarkdown.value = text;
      setStatus("success", "Pasted from clipboard.");
    }catch(err){
      setStatus("danger", `Paste failed: ${err && err.message ? err.message : String(err)}`);
    }
  }

  async function copyToClipboard(){
    try{
      const text = outputMarkdown.value || "";
      if(!text.trim()){
        setStatus("warning", "Output is empty. Run Convert first.");
        return;
      }

      if(navigator.clipboard && navigator.clipboard.writeText){
        try{
          await navigator.clipboard.writeText(text);
          setStatus("success", "Copied output to clipboard.");
          return;
        }catch(e){
          // fall through to manual copy
        }
      }

      outputMarkdown.focus();
      outputMarkdown.select();
      setStatus("warning", "Clipboard API unavailable/failed. Output selected for manual copy (Ctrl/Cmd+C).");
    }catch(err){
      setStatus("danger", `Copy failed: ${err && err.message ? err.message : String(err)}`);
    }
  }

  function onConvert(){
    try{
      const headingText = (headingInput.value || "References").trim() || "References";
      const input = inputMarkdown.value || "";
      const result = convert(input, headingText);
      outputMarkdown.value = result;
      setStatus("success", "Conversion complete.");
    }catch(err){
      setStatus("danger", `Conversion failed: ${err && err.message ? err.message : String(err)}`);
    }
  }

  pasteBtn.addEventListener("click", pasteFromClipboard);
  convertBtn.addEventListener("click", onConvert);
  copyBtn.addEventListener("click", copyToClipboard);

  // Init
  loadTheme();
})();
</script>
</body>
</html>
