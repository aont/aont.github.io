<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Blank page</title>
<style>
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; max-width: 720px; margin: 0 auto; }
textarea { width: 100%; box-sizing: border-box; padding: 12px; font-size: 14px; }
.row { display: flex; gap: 8px; margin-top: 12px; align-items: center; flex-wrap: wrap; }
button { padding: 10px 14px; font-size: 14px; cursor: pointer; }
.output { margin-top: 16px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; word-break: break-all; }
</style>
<script>
window.addEventListener("load", function () {
    // 1) Prefer the `message` query string if present
    const params = new URLSearchParams(window.location.search);
    const messageFromQuery = params.get("message"); // can be null

    // 2) Fallback: detect browser name (legacy behavior)
    let browserName;
    if (navigator.userAgentData && Array.isArray(navigator.userAgentData.brands)) {
        const brandSpecific = navigator.userAgentData.brands.find(function (brand) {
            return brand && (brand.brand === "Google Chrome" || brand.brand === "Microsoft Edge");
        });
        browserName = brandSpecific
            ? (brandSpecific.brand + " " + brandSpecific.version)
            : navigator.userAgentData.brands.map(function (brand) {
                return brand.brand + " " + brand.version;
            }).join(", ");
    } else {
        browserName = navigator.userAgent;
    }

    // 3) Decide the text to display
    // If `message` is an empty string or only whitespace, fall back to browserName
    const displayText = (messageFromQuery && messageFromQuery.trim().length > 0)
        ? messageFromQuery
        : browserName;

    // 4) Click -> open popup -> show text -> go back (preserve original flow)
    const a = document.createElement("a");

    const clickPromise = new Promise(function(resolve) {
        a.addEventListener("click", function () {
            const s = window.screen;
            const w = window.open(
                "about:blank",
                "_blank",
                "popup,location=0,menubar=no,toolbar=no,location=no,status=no,scrollbars=no,width=300,height=100,left=" +
                    s.availWidth.toString() + ",top=" + s.availHeight.toString()
            );
            if (w) {
                // Avoid XSS: build elements and set textContent
                const link = w.document.createElement("a");
                link.href = "about:blank";
                link.target = "_blank";
                link.textContent = displayText;
                w.document.body.appendChild(link);
            }
            resolve(null);
            return false;

        }, { once: true });
    });

    document.body.appendChild(a);

    // Trigger click programmatically
    a.click();

    // After popup, remove the prompt link and navigate back
    clickPromise.then(function (w) {
        if (w) {
            document.body.removeChild(a);
            a.remove();
        } else {
            document.getElementById("popup-hint").style.display = "block";
        }
    });


    const $msg = document.getElementById("msg");
    const $out = document.getElementById("out");
    const $link = document.getElementById("link");
    const $url  = document.getElementById("url");
    const $gen  = document.getElementById("gen");
    const $copy = document.getElementById("copy");

    function buildUrl(text) {
        return location.protocol + "//" + location.host + location.pathname + "?message=" + encodeURIComponent(text);
    }

    function render() {
        const text = $msg.value ?? "";
        const generated = buildUrl(text);

        $link.href = generated;
        $url.textContent = generated;

        $out.hidden = false;
    }

    $gen.addEventListener("click", render);

    $copy.addEventListener("click", async () => {
        const text = $msg.value ?? "";
        const generated = buildUrl(text);
        try {
            await navigator.clipboard.writeText(generated);
            // Simple feedback
            $copy.textContent = "Copied";
            setTimeout(() => ($copy.textContent = "Copy URL"), 1200);
        } catch (e) {
            // Fallback if clipboard API isn't available
            prompt("Copy this URL:", generated);
        }
    });

    // If you want live updates as the user types, enable this:
    // $msg.addEventListener("input", render);
});
</script>
</head>
<body>
<div style="display: none;" id="popup-hint">If the window does not appear, please allow pop-ups for this window.</div>

<label for="msg">Message</label><br />
<textarea id="msg" rows="6" placeholder="Type your message here..."></textarea>

<div class="row">
<button id="gen" type="button">Generate Link</button>
<button id="copy" type="button">Copy URL</button>
</div>

<div class="output" id="out" hidden>
<div>Generated link:</div>
<div style="margin-top: 8px;">
<a id="link" href="#" rel="noopener">Open this link</a>
</div>
<div class="mono" id="url" style="margin-top: 8px;"></div>
</div>

</body>
</html>
